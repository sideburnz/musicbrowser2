<Mcml xmlns="http://schemas.microsoft.com/2008/mcml"
      xmlns:me="Me"
      xmlns:entities="assembly://MusicBrowser/MusicBrowser.Entities"
      xmlns:actions="assembly://MusicBrowser/MusicBrowser.Actions"
      xmlns:models="assembly://MusicBrowser/MusicBrowser.Models"
      xmlns:cor="assembly://MSCorLib/System">

  <UI Name="ctrlActionPopup">
    
    <Properties>
      <models:ActionsModel Name="Model" ActionsModel="$Required" />

      <Command Name="CmdClose"/>
      <Command Name="CmdHome" />
      <Command Name="CmdEnd" />
    </Properties>

    <Locals>
      <ShortcutHandler Name="BackHandler" Handle="true" Shortcut="Back" HandlerStage="Bubbled" Command="[CmdClose]"/>
      <KeyHandler Name="EscHandler" Handle="true" Key="Escape" HandlerStage="Bubbled" Command="[CmdClose]"/>

      <KeyHandler Name="HomeHandler" Handle="true" Key="PageUp" HandlerStage="Bubbled" Command="[CmdHome]"/>
      <KeyHandler Name="EndHandler" Handle="true" Key="PageDown" HandlerStage="Bubbled" Command="[CmdEnd]"/>
    </Locals>

    <Rules>
      <Default Target="[Input.MakeTopmostOnFocus]" Value="true"/>
      <Default Target="[Input.CreateInterestOnFocus]" Value="true" />

      <Binding Target="[viewListRepeater.Source]" Source="[Model.Context.Actions]" />

      <Changed Source="[CmdClose.Invoked]">
        <Actions>
          <Set Target="[Model.Visible]" Value="false" />
        </Actions>
      </Changed>

      <Changed Source="[HomeHandler.Invoked]">
        <Actions>
          <Invoke Target="[viewListRepeater.NavigateIntoIndex]" index="0" />
        </Actions>
      </Changed>
      <!-- fix these -->
      <Changed Source="[CmdEnd.Invoked]">
        <Actions>
          <Invoke Target="[viewListRepeater.NavigateIntoIndex]" index="[viewListRepeater.Source.Count]" />
        </Actions>
      </Changed>
    </Rules>

    <Content>
      <ColorFill Content="Transparent" Navigation="ContainAll" Name="ActionPopUp" Layout="Fill">
        <Layout>
          <FlowLayout Orientation="Vertical"/>
        </Layout>
        <Children>
          <Repeater Layout="Fill" Name="viewListRepeater" Navigation="ContainAll">
            <Layout>
              <FlowLayout Orientation="Vertical" ItemAlignment="Center"/>
            </Layout>
            <Content>
              <me:buttonAction Action="[RepeatedItem!actions:baseActionCommand]" />
            </Content>
          </Repeater>
        </Children>
      </ColorFill>
    </Content>
  </UI>


  <UI Name="buttonAction">
    
    <Properties>
      <actions:baseActionCommand Name="Action" baseActionCommand="$Required" />
    </Properties>

    <Locals>
      <ClickHandler Name="Clicker" />
      <Command Name="CmdChange" />
    </Locals>

    <Rules>
      <Condition Source="[Input.KeyFocus]" SourceValue="true">
        <Actions>
          <Set Target="[Frame.Content]" Value="resx://MusicBrowser/MusicBrowser.Resources/ButtonLeftFocus"/>
          <Set Target="[txtLabel.Alpha]" Value="1" />
        </Actions>
      </Condition>

      <Condition Source="[Input.KeyFocus]" SourceValue="false">
        <Actions>
          <Set Target="[Frame.Content]" Value="resx://MusicBrowser/MusicBrowser.Resources/nullImage"/>
          <Set Target="[txtLabel.Alpha]" Value="0.5" />
        </Actions>
      </Condition>

      <Default Target="[Input.KeyInteractive]" Value="true" />
      <Binding Source="[CmdChange]" Target="[Clicker.Command]" />

      <Changed Source="[CmdChange.Invoked]">
        <Actions>
          <Invoke Target="[Action.Invoke]" />
        </Actions>
      </Changed>

    </Rules>

    <Content>
      <Graphic Name="Frame" MinimumSize="360,57" MaximumSize="360,57" Content="resx://MusicBrowser/MusicBrowser.Resources/nullImage">
        <Layout>
          <FlowLayout Orientation="Horizontal" ItemAlignment="Near" />
        </Layout>
        <Children>
          <Graphic Name="grpIcon" Content="[Action.Icon]" MaximumSize="25,25" MinimumSize="25,25" MaintainAspectRatio="true" Margins="12,16,3,0" Visible="true" />
          <Text Name="txtLabel" Content="[Action.Label]" Color="White" FadeSize="5" Font="Segoe Media Center, 22" Margins="4,10,0,0" />
        </Children>
      </Graphic>
    </Content>
    
  </UI>

</Mcml>